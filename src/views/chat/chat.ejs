<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Page</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="h-screen flex flex-col">
    <!-- Header -->
    <div
      id="chat-header"
      class="flex items-center justify-start bg-gray-100 p-4 shadow"
    >
      <img
        id="chat-header-img"
        src="https://placehold.co/40"
        alt="Profile"
        class="w-10 h-10 rounded-full mr-3"
      />
      <span id="chat-header-name" class="text-lg font-semibold"
        ><%= chatInfo.to %></span
      >
    </div>

    <!-- Messages Container (flex-1) -->
    <div
      id="messages-container"
      class="flex-1 overflow-y-auto bg-white p-4 space-y-4"
    >
      <!-- Messages will be dynamically appended here -->
    </div>

    <!-- Bottom Bar -->
    <div id="chat-input-bar" class="bg-gray-100 p-4 flex items-center shadow">
      <input
        id="chat-input"
        type="text"
        class="flex-1 border border-gray-300 rounded px-3 py-2 mr-3 focus:outline-none"
        placeholder="Type your message..."
      />
      <button
        id="send-button"
        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
      >
        Send
      </button>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const chatInfo = JSON.parse(`<%- JSON.stringify(chatInfo) %>`);
      const Message = (from, message) => {
        const isSender = from === chatInfo.from;

        return `
          <div class="flex ${isSender ? "justify-end" : "justify-start"}">
            <div
              class="px-4 py-2 max-w-xs rounded-lg text-white ${
                isSender
                  ? "bg-blue-500 text-right"
                  : "bg-gray-300 text-left text-black"
              }"
            >
              <span class="block text-sm font-semibold mb-1">${
                isSender ? "You" : from
              }</span>
              <span>${message}</span>
            </div>
          </div>
        `;
      };
    </script>
    <script>
      const input = document.getElementById("chat-input");
      const sendButton = document.getElementById("send-button");

      const messagesContainer = document.getElementById("messages-container");
      const socket = io("ws://localhost:8000", {
        query: {
          id: chatInfo.id,
          user: JSON.stringify({
            name: "Visvesh",
          }),
        },
      });

      chatInfo.messages.forEach((message) => {
        messagesContainer.innerHTML += Message(message.from, message.content);
      });

      socket.on(`chat`, (message) => {
        messagesContainer.innerHTML += Message(message.from, message.content);
      });

      sendButton.addEventListener("click", () => {
        const message = input.value;
        if (message) {
          socket.emit(`chat`, {
            from: chatInfo.from,
            content: message,
          });
          messagesContainer.innerHTML += Message(
            `<%- chatInfo.from %>`,
            message
          );
          input.value = "";
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      });
    </script>
  </body>
</html>
